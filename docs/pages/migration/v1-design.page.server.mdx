import { Link, Note } from '@brillout/docpress'

<Note type='warning'>The [V1 design](https://github.com/brillout/vite-plugin-ssr/issues/578) is in beta. While the overall V1 design is settled, some minor breaking changes may occur between versions.</Note>

> You need to either fully use the V1 design, or fully use the old design. You cannot mix both.

Despite what it may seem, the migration is usually fairly straightforward and quick to implement. We encourage to migrate sooner rather than later.

> Don't hesitate to reach out if you run into any issue.

While the V1 design is a fairly simple redesign, it adds new foundational capabilities. If you're curious, see <Link href="/why-the-v1-design" />

## Main migration

Most of the migration boils down to the following two steps.

> Make sure to update `vite-plugin-ssr` to its latest version.

**1. Migrate `/renderer/*.page.*`**

Move your `renderer/` hooks to standalone files:

```diff
- // /renderer/_default.page.server.js
+ // /renderer/+onRenderHtml.js

- export { render }
+ export default render
```
```diff
- // /renderer/_default.page.client.js
+ // /renderer/+onRenderClient.js

- export { render }
+ export default render
```

> The suffixes such as `.page.server.js` and `.page.client.js` are removed. You'll still be able to use `.server.js` and `.client.js` suffixes but they'll serve another purpose, see [#744](https://github.com/brillout/vite-plugin-ssr/issues/744).

Move your renderer configurations to `/renderer/+config.ts`:

```diff
- // /renderer/_default.page.client.ts

- export { clientRouting }
- export { hydrationCanBeAborted }
```

```ts
// /renderer/+config.ts

import type { Config } from 'vite-plugin-ssr/types'

export default {
  clientRouting: true,
  hydrationCanBeAborted: true
} satisfies Config
```

Move your error page (if you defined one):

```diff
- // /renderer/_error.page.js
+ // /pages/_error/+Page.js

- export { Page }
+ export default Page
```


**2. Migrate `/pages/**/*.page.*`**

```diff
- // /pages/some-page/index.page.ts
+ // /pages/some-page/+Page.ts

- export { Page }
+ export default Page
```
```diff
- // /pages/some-page/index.page.server.ts
+ // /pages/some-page/+onBeforeRender.ts

- export { onBeforeRender }
+ export default onBeforeRender
```

```diff
- // /pages/some-page/index.page.route.ts
+ // /pages/some-page/+config.ts

- export default '/some/route'
+ // Only works for Route Strings
+ export default {
+   route: '/some/route'
+ }
```

```diff
- // /pages/some-page/index.page.route.ts
+ // /pages/some-page/+route.ts

// Works for both Route Functions and Route Strings
export default route
```

> We explain down below why Route Functions cannot be defined inside `+config.js`.

> Each page lives in its own new directory and `+config.js` is optional:
> ```bash
> # ✅ V1 Design
> $ ls pages/**/*
> /pages/some-page/+config.js
> /pages/some-page/+Page.js
> /pages/some-other-page/+Page.js
> ```
> ```bash
> # ❌ This isn't possible anymore: each page now needs to create a new directory
> # Old design
> $ ls pages/**/*
> /pages/some.page.js
> /pages/some-other.page.js
> ```

For further examples, see the [list of migration examples](#examples).

Apply following additional steps if you define:
 - <Link text="Renamed hooks" href="#renamed-hooks" />
 - <Link text="Custom hooks/exports" href="#custom-hooks-exports" />
 - [`onBeforeRender` in `.page.js`](#onbeforerender-in-page-js) (instead of `.page.server.js`)
 - <Link text="Additional client code" href="#additional-client-code" />


## What are `+` files?

The `+` files define the entire interface between your app and VPS.

You can define your entire app only by defining `+config.js` files:
 - One `/pages/+config.js` (to define your overall global configuration).
 - One `/pages/some-page/+config.js` per page (to define your pages).

> Your `+config.js` of your pages files (such as `/pages/some-page/+config.js`) can completely override your global `/pages/+config.js`. This means that your global `+config.js` merely defines default values.

For conveniences, you can use the following:
 1. Files such as `+onRenderHtml.js` which is just an alias for `+config.js > export default { onRenderHtml }`.
 1. `/renderer/+config.js` which is equivalent to `/pages/+config.js`.
    > `/renderer/+config.js` is an (optional) convenience for having your renderer logic/files live outside of `/pages/**/*` (instead of cluttering your `/pages/` directory).

Note that the following is forbidden:

```js
// /pages/some-page/+config.js

export default {
  Page,
  onBeforeRender
}

function Page() {
  // ...
}
function onBeforeRender() {
  // ...
}
```

VPS throws an error `[Wrong Usage] Hooks cannot be defined within +config.js`. Do this instead:

```js
// /pages/some-page/+config.js

import Page from './some-file'
import onBeforeRender from './some-other-file'

export default { Page, onBeforeRender }
```

All imports in `+config.js` are removed and loaded separately, in order to ensure that files are loaded in the right environment. See <Link href="/config-code-splitting" /> for more informaton.

> The `+` convention has been [comprehensively discussed](https://github.com/brillout/vite-plugin-ssr/issues/578#issuecomment-1472005734). While we agree that `+` files are ugly at first, we believe that you'll eventually end up liking it as much as we do. It brings many subtle yet important advantages.


## Examples

Migration examples:
 - Migration of basic app: [`428c1c` - migrate examples/react to V1 design](https://github.com/brillout/vite-plugin-ssr/commit/428c1c6b0fb7c9a5fa2f2fe57ac3e4bb0a57ea54)
 - Migration from a custom export to a custom config: [`f28880` - migrate /examples/custom-preload/ to V1 Design](https://github.com/brillout/vite-plugin-ssr/commit/f28880b0b85cde12647aa0613c99dbdeadc467de)

All official examples have been migrate to the V1 design: see [`examples/*-v1`](https://github.com/brillout/vite-plugin-ssr/tree/main/examples) and compare them with their non-v1 counterpart.


## Renamed hooks

Old name | New name
-|-
`render()` in `.page.client.js` | `onRenderClient()`
`render()` in `.page.server.js` | `onRenderHtml()`
`prerender()` | `onBeforePrerenderStart()`
`onBeforePrerender()` | `onPrerenderStart()`

The hooks are equivalent: they just have a new name.

Also note that `doNotPrerender` has been renamed:

Old name | New name
-|-
`doNotPrerender: true` | `prerender: false`

```diff
// /pages/news.page.server.js

- export const doNotPrerender = true
```
```diff
// /pages/news/+config.js

  export default {
+   prerender: false
  }
```


## Custom hooks/exports

If you use <Link text="custom hooks/exports" href="/exports" />, then replace them with custom configs.

You define custom configs by using `meta`:

```ts
// /renderer/+config.ts

import type { Config } from 'vite-plugin-ssr/types'

export default {
  meta: {
    // We define a new config 'title'
    title: {
      // The value of 'title' should only be loaded on the server
      env: 'server-only'
    }
  }
} satisfies Config
```

```js
// /renderer/+onRenderHtml.js

export default function(pageContext) {
  // Configs are available at pageContext.config
  const { title } = pageContext.config
  return escapeInject`<html>
    <head>
      <title>${title}</title>
    </head>
    <!-- ... -->
  </html>`
}
```

```js
// /pages/about/+config.js

export default {
  title: 'Demo showcasing the V1 design'
}
```

Examples:
 - [/examples/react-full-v1/ > `/renderer/config.ts` > `meta`](https://github.com/brillout/vite-plugin-ssr/blob/79c2d9d614240160fa9f60f08dfd2b33cc5b3a27/examples/react-full-v1/renderer/%2Bconfig.ts#L8)
 - [/examples/render-modes-v1/ > `/renderer/config.ts` > `meta`](https://github.com/brillout/vite-plugin-ssr/blob/79c2d9d614240160fa9f60f08dfd2b33cc5b3a27/examples/render-modes-v1/renderer/%2Bconfig.ts#L9)


## `onBeforeRender` in `.page.js`

If you have `onBeforeRender()` hooks defined in `.page.js` instead of `.page.server.js`:

```ts
// /renderer/+config.ts

import type { Config } from 'vite-plugin-ssr/types'

export default {
  meta: {
    onBeforeRender: {
      // Tell VPS to load and execute onBeforeRender() not only on the server but
      // also in the client.
      env: 'server-and-client'
    }
  }
} satisfies Config
```

For convenience, you can also define a [custom config `onBeforeRenderIsomorph: boolean`](https://github.com/brillout/vite-plugin-ssr/blob/79c2d9d614240160fa9f60f08dfd2b33cc5b3a27/examples/react-full-v1/renderer/+config.ts#L12-L31) for a [page-per-page toggle](https://github.com/brillout/vite-plugin-ssr/blob/79c2d9d614240160fa9f60f08dfd2b33cc5b3a27/examples/react-full-v1/pages/star-wars/%40id/%2BonBeforeRenderIsomorph.ts).


## Additional client code

For adding client-side code, you can continue using the same hooks as before: <Link text={<><code>onHydrationEnd()</code>, <code>onPageTransitionStart()</code>, and <code>onPageTransitionEnd()</code></>} href="/clientRouting#usage-options" doNotInferSectionTitle={true} />.

You can now also use the new config `client`:

```js
// +config.js
export default {
  client: './some-client-code.js'
}
```

```js
// some-client-code.js
console.log("I'm run when the client-side JavaScript is loaded.")
```
