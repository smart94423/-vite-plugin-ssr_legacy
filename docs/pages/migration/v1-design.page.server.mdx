import { Link, Note } from '@brillout/docpress'

<Note type='warning'>The [V1 design](https://github.com/brillout/vite-plugin-ssr/issues/578) is in beta: minor breaking changes may occur between version updates.</Note>

The overall architecture of vite-plugin-ssr stays the same: the V1 design simply replaces `.page.js` files with `+` files: `+config.js`, `+Page.js`, `+route.js`, ...

The V1 design adds new foundational capabilities. If you're curious see <Link href="/why-the-v1-design" />

The migration is straightforward and usually quick to implement. We encourage to migrate sooner rather than later.

> Don't hesitate to reach out if you run into any issues.

## Main migration

Most of the migration boils down to the following two steps.

> Make sure to update `vite-plugin-ssr` to its latest version before migrating.

> You need to either fully use the V1 design, or fully use the old design. You cannot mix both.

**1. Migrate `/renderer/*.page.*`**

Move your `renderer/` hooks to `+` files:

```diff
- // /renderer/_default.page.server.js
+ // /renderer/+onRenderHtml.js

- export { render }
+ export default render
```

If you have defined a global `onBeforeRender()` hook and/or `passToClient`:

```diff
- // /renderer/_default.page.server.js
+ // /renderer/+onRenderRender.js

- export { onBeforeRender }
- export const passToClient = ['pageProps']
+ export default onBeforeRender
```

```diff
+ // /renderer/+config.ts
+ 
+ import type { Config } from 'vite-plugin-ssr/types'
+ 
+ export default {
+   passToClient: ['pageProps']
+ } satisfies Config
```


> Files such as `+onRenderHtml.js` are thoroughly explained at:
>  - <Link href="/architecture#config-js" />
>  - <Link href="/config" />

```diff
- // /renderer/_default.page.client.js
+ // /renderer/+onRenderClient.js

- export { render }
+ export default render
```

> The suffixes such as `.page.server.js` and `.page.client.js` don't exist anymore. After the feature request [#744](https://github.com/brillout/vite-plugin-ssr/issues/744) is implemented, you'll be able to use `.server.js` and `.client.js` suffixes again but they'll serve another purpose.

Move `/renderer/` configurations to `/renderer/+config.ts`:

```diff
- // /renderer/_default.page.client.ts

- export { clientRouting }
- export { hydrationCanBeAborted }
```

```ts
// /renderer/+config.ts

import type { Config } from 'vite-plugin-ssr/types'

export default {
  clientRouting: true,
  hydrationCanBeAborted: true
} satisfies Config
```

Move your error page (if you defined one):

```diff
- // /renderer/_error.page.js
+ // /pages/_error/+Page.js

- export { Page }
+ export default Page
```


**2. Migrate `/pages/**/*.page.*`**

```diff
- // /pages/some-page/index.page.ts
+ // /pages/some-page/+Page.ts

- export { Page }
+ export default Page
```
```diff
- // /pages/some-page/index.page.server.ts
+ // /pages/some-page/+onBeforeRender.ts

- export { onBeforeRender }
+ export default onBeforeRender
```

```diff
- // /pages/some-page/index.page.route.ts
+ // /pages/some-page/+route.ts

export default route
```

> Each page now lives in its own new directory
> ```bash
> # ✅ V1 design
> $ ls pages/**/*
> /pages/some-page/+Page.js
> /pages/some-other-page/+Page.js
> ```
> ```bash
> # ❌ This isn't possible anymore: each page now needs to create a new directory
> $ ls pages/**/*
> /pages/some.page.js
> /pages/some-other.page.js
> ```

Apply following additional steps if you have defined:
 - <Link text="Renamed hooks" href="#renamed-hooks" />
 - <Link text="Custom hooks/exports" href="#custom-hooks-exports" />
 - [`onBeforeRender` in `.page.js`](#onbeforerender-in-page-js) (instead of `.page.server.js`)
 - <Link text="Additional client code" href="#additional-client-code" />


## Examples

All official examples have been migrated, see [`examples/*-v1`](https://github.com/brillout/vite-plugin-ssr/tree/main/examples).

Most notably the migration of:
 - Basic apps:
   - [migrate /examples/react](https://github.com/brillout/vite-plugin-ssr/commit/428c1c6b0fb7c9a5fa2f2fe57ac3e4bb0a57ea54)
   - [migrate /examples/vue](https://github.com/brillout/vite-plugin-ssr/commit/b87e6dc85462d74f16fdfd0eb4dee1c2c8d29325)
 - A `onBeforeRender()` hook:
   - Defined by page in `pages/`:
     - [migrate /examples/telefunc](https://github.com/brillout/vite-plugin-ssr/commit/bfcd801419acd18c676b49d835c805ef6e89a607#diff-41adf2b043a30483759686ad913c5dba5dc4d0594d45913cf5a504f2205ce8a4)
     - [migrate /examples/i18n](https://github.com/brillout/vite-plugin-ssr/commit/9dd3db3bb6f0c1fc16befa9f504e94ea732339e8#diff-c4d06dd7331553f9855baa90f752a40b51c379631574135f38e50c9da40fa1ee)
     - [migrate /examples/react-full](https://github.com/brillout/vite-plugin-ssr/commit/8e71e27802b1990fae360b4ce01935e12fc09237#diff-793fcad526e46c52916bab033cd16d35f05e1a6f18e4e43b45b3a28b8ba34f59)
     - [migrate /examples/vue-full](https://github.com/brillout/vite-plugin-ssr/commit/b612023a6b209424a75aacb2fde9b2305c44f3ee#diff-adc0afea381da59cdf122fc6cbb11a3df777fc6436d4999d6e106ad0f7330160)
   - Defined globally in `renderer/`:
     - [migrate /examples/redux](https://github.com/brillout/vite-plugin-ssr/commit/69c06b03c5ce5199147eb0f2e574c626038d18a7)
     - [migrate /examples/graphql-apollo-vue/](https://github.com/brillout/vite-plugin-ssr/commit/aa2055f731f2ed8fc4f8763edcdc1f76ced7d061)
     - [migrate /examples/vue-pinia](https://github.com/brillout/vite-plugin-ssr/commit/2b830d0db9a9cd2cb9b4402a00887cd840a16eda)
     - [migrate /examples/vuex](https://github.com/brillout/vite-plugin-ssr/commit/499d01e3f44328e2d74747169ef65236253ac6f6)
 - Pre-rendered app (using `prerender()` hooks):
   - [migrate /examples/react-full](https://github.com/brillout/vite-plugin-ssr/commit/8e71e27802b1990fae360b4ce01935e12fc09237#diff-793fcad526e46c52916bab033cd16d35f05e1a6f18e4e43b45b3a28b8ba34f59)
   - [migrate /examples/vue-full](https://github.com/brillout/vite-plugin-ssr/commit/b612023a6b209424a75aacb2fde9b2305c44f3ee)
 - Custom exports to custom configs (see explanation at <Link href="#custom-hooks-exports" doNotInferSectionTitle={true} />):
   - `pageContext.exports.documentProps` -> `pageContext.config.title`:
   - [migrate /examples/vue-full](https://github.com/brillout/vite-plugin-ssr/commit/b612023a6b209424a75aacb2fde9b2305c44f3ee)
     - [migrate /examples/react-full](https://github.com/brillout/vite-plugin-ssr/commit/8e71e27802b1990fae360b4ce01935e12fc09237#diff-793fcad526e46c52916bab033cd16d35f05e1a6f18e4e43b45b3a28b8ba34f59)
   - `pageContext.exports.Layout` -> `pageContext.config.Layout`:
     - [migrate /examples/layouts-react](https://github.com/brillout/vite-plugin-ssr/commit/9b31b7497510d4add7c0e4aa4f19675b2f37fa94#diff-366cb44a235f430b996e8cfb4a0e2a65388e9ea23caf635363ee87e56666d52eL9-R9)
     - [migrate /examples/layouts-vue](https://github.com/brillout/vite-plugin-ssr/commit/499ee0184c4a6331e399ded299f413fc1d1a46e3)
   - `pageContext.exports.preloadStrategy` -> `pageContext.config.preloadStrategy`:
     - [migrate /examples/custom-preload](https://github.com/brillout/vite-plugin-ssr/commit/f28880b0b85cde12647aa0613c99dbdeadc467de#diff-f1f3a4c9f73f2c7ee1444e278cf4c6115efbee1cc294649e8f5a2a05a593f18dL15-R12)
 - I18n (pre-rendered) app (using hooks `onBeforeRoute()`, `onBeforePrerender()`, and `prerender()`):
   - [migrate /examples/i18n](https://github.com/brillout/vite-plugin-ssr/commit/9dd3db3bb6f0c1fc16befa9f504e94ea732339e8#diff-50a58ddbb03951878eebb954f765ff2406b04dad278c69c9ce03d9bff567ad76)



## Renamed hooks

Old name | New name
-|-
`render()` in `.page.client.js` | `onRenderClient()`
`render()` in `.page.server.js` | `onRenderHtml()`
`prerender()` | `onBeforePrerenderStart()`
`onBeforePrerender()` | `onPrerenderStart()`

The hooks are equivalent: they just have a new name.

Also note that `doNotPrerender` has been renamed:

Old name | New name
-|-
`doNotPrerender: true` | `prerender: false`

```diff
// /pages/news.page.server.js

- export const doNotPrerender = true
```
```diff
// /pages/news/+config.js

  export default {
+   prerender: false
  }
```


## Custom hooks/exports

If you use <Link text="custom hooks/exports" href="/exports" />, then replace them with custom configs.

You define custom configs by using `meta`:

```ts
// /renderer/+config.ts

import type { Config } from 'vite-plugin-ssr/types'

export default {
  meta: {
    // We define a new config 'title'
    title: {
      // The value of 'title' should only be loaded on the server
      env: 'server-only'
    }
  }
} satisfies Config
```

```js
// /renderer/+onRenderHtml.js

export default function(pageContext) {
  // Configs are available at pageContext.config
  const { title } = pageContext.config
  return escapeInject`<html>
    <head>
      <title>${title}</title>
    </head>
    <!-- ... -->
  </html>`
}
```

```js
// /pages/about/+config.js

export default {
  title: 'Demo showcasing the V1 design'
}
```

Examples:
 - [/examples/react-full-v1/ > `/renderer/config.ts` > `meta`](https://github.com/brillout/vite-plugin-ssr/blob/79c2d9d614240160fa9f60f08dfd2b33cc5b3a27/examples/react-full-v1/renderer/%2Bconfig.ts#L8)
 - [/examples/render-modes-v1/ > `/renderer/config.ts` > `meta`](https://github.com/brillout/vite-plugin-ssr/blob/79c2d9d614240160fa9f60f08dfd2b33cc5b3a27/examples/render-modes-v1/renderer/%2Bconfig.ts#L9)


## `onBeforeRender` in `.page.js`

If you have `onBeforeRender()` hooks defined in `.page.js` instead of `.page.server.js`:

```ts
// /renderer/+config.ts

import type { Config } from 'vite-plugin-ssr/types'

export default {
  meta: {
    onBeforeRender: {
      // Tell VPS to load and execute onBeforeRender() not only on the server but
      // also in the client.
      env: 'server-and-client'
    }
  }
} satisfies Config
```

For convenience, you can also define a [custom config `onBeforeRenderIsomorph: boolean`](https://github.com/brillout/vite-plugin-ssr/blob/79c2d9d614240160fa9f60f08dfd2b33cc5b3a27/examples/react-full-v1/renderer/+config.ts#L12-L31) for a [page-per-page toggle](https://github.com/brillout/vite-plugin-ssr/blob/79c2d9d614240160fa9f60f08dfd2b33cc5b3a27/examples/react-full-v1/pages/star-wars/%40id/%2BonBeforeRenderIsomorph.ts).


## Additional client code

For adding client-side code, you can continue using the same hooks as before: <Link text={<><code>onHydrationEnd()</code>, <code>onPageTransitionStart()</code>, and <code>onPageTransitionEnd()</code></>} href="/clientRouting#usage-options" doNotInferSectionTitle={true} />.

You can now also use the new config `client`:

```js
// +config.js
export default {
  client: './some-client-code.js'
}
```

```js
// some-client-code.js
console.log("I'm run when the client-side JavaScript is loaded.")
```

See also:
 - <Link href="/client" />
